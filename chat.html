<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlexVoiceChat</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #0f0f0f; color: #e0e0e0; margin: 0; }
        #status-card { background: #1e1e1e; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; border: 1px solid #333; min-width: 280px; }
        #status { font-size: 1.4rem; margin-bottom: 15px; font-weight: 300; }
        .dot { height: 12px; width: 12px; background-color: #555; border-radius: 50%; display: inline-block; margin-right: 10px; transition: 0.3s; }
        .online { background-color: #00ff88; box-shadow: 0 0 15px #00ff88; }
        .busy { background-color: #ff4444; box-shadow: 0 0 15px #ff4444; }
        .info { color: #888; font-size: 0.9rem; margin-top: 10px; }

        #controls {
            margin-top: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        
        .mic-btn {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            background: #333;
            color: white;
            font-size: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            margin: 0 auto;
        }
        
        .mic-btn:active { transform: scale(0.9); }
        .mic-btn.active {
            background: #00ff88;
            color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }
        .mic-btn.muted {
            background: #ff4444;
            color: #fff;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.3);
        }
        
        #mic-label { 
            margin-top: 12px;
            font-weight: bold; 
            letter-spacing: 0.5px; 
            display: block;
            width: 100%;
            text-align: center;
        }

        .volume-container {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #333;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .volume-container label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        input[type=range] {
            width: 90%;
            cursor: pointer;
            accent-color: #00ff88;
        }
    </style>
</head>
<body>

    <div id="status-card">
        <div id="status"><span class="dot" id="indicator"></span> –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
        <div id="sub-status" class="info">–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...</div>
        
        <div id="controls">
            <button id="micToggle" class="mic-btn active">üé§</button>
            <div id="mic-label" class="info">–ú–∏–∫—Ä–æ—Ñ–æ–Ω –í–ö–õ</div>
        </div>

        <div class="volume-container">
            <label for="volumeSlider">–ì—Ä–æ–º–∫–æ—Å—Ç—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞: <span id="volumeValue">100</span>%</label>
            <input type="range" id="volumeSlider" min="0" max="100" value="100">
            <div class="info" style="font-size: 0.7rem;">–°–æ–≤–µ—Ç: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–ª–µ—Å–∏–∫–æ –º—ã—à–∏</div>
        </div>
    </div>
    
    <audio id="remoteAudio" autoplay></audio>

    <script>
        const ROOM_ID = 'alex-voice-room-unique-123'; 
        const statusText = document.getElementById('status');
        const subStatus = document.getElementById('sub-status');
        const indicator = document.getElementById('indicator');
        const remoteAudio = document.getElementById('remoteAudio');
        const micToggle = document.getElementById('micToggle');
        const micLabel = document.getElementById('mic-label');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeValue = document.getElementById('volumeValue');

        let localStream;
        let peer = null;
        let currentCall = null;
        let isMuted = false;

        async function init() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                subStatus.innerText = "–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≥–æ—Ç–æ–≤. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–Ω–∞—Ç—ã...";
                
                // Event listeners for UI
                micToggle.addEventListener('click', toggleMic);
                volumeSlider.addEventListener('input', updateVolume);
                
                // Add wheel support for volume
                volumeSlider.addEventListener('wheel', handleVolumeWheel, { passive: false });
                
                startPeer();
            } catch (err) {
                statusText.innerText = "–û—à–∏–±–∫–∞";
                subStatus.innerText = "–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω –∏–ª–∏ –æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.";
                console.error(err);
            }
        }

        function toggleMic() {
            if (!localStream) return;
            isMuted = !isMuted;
            
            // Toggle local track status
            localStream.getAudioTracks().forEach(track => {
                track.enabled = !isMuted;
            });

            // Update UI elements
            if (isMuted) {
                micToggle.classList.remove('active');
                micToggle.classList.add('muted');
                micLabel.innerText = "–ú–∏–∫—Ä–æ—Ñ–æ–Ω –í–´–ö–õ";
                micToggle.innerText = "üîá";
            } else {
                micToggle.classList.remove('muted');
                micToggle.classList.add('active');
                micLabel.innerText = "–ú–∏–∫—Ä–æ—Ñ–æ–Ω –í–ö–õ";
                micToggle.innerText = "üé§";
            }
        }

        function updateVolume() {
            const val = volumeSlider.value;
            // Native audio volume scale is 0 to 1
            remoteAudio.volume = val / 100;
            volumeValue.innerText = val;
        }

        function handleVolumeWheel(e) {
            // Prevent page from scrolling
            e.preventDefault();
            
            const step = 5;
            let currentVal = parseInt(volumeSlider.value);
            
            if (e.deltaY < 0) {
                // Wheel scrolled up
                currentVal = Math.min(100, currentVal + step);
            } else {
                // Wheel scrolled down
                currentVal = Math.max(0, currentVal - step);
            }
            
            volumeSlider.value = currentVal;
            updateVolume();
        }

        function startPeer() {
            const hostPeer = new Peer(ROOM_ID);

            hostPeer.on('open', () => {
                statusText.innerText = "–û–∂–∏–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞...";
                subStatus.innerText = "–í—ã ‚Äî –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä. –ü–µ—Ä–µ–¥–∞–π—Ç–µ —Å—Å—ã–ª–∫—É –¥—Ä—É–≥—É.";
                indicator.classList.remove('busy');
                indicator.classList.add('online');

                hostPeer.on('call', (call) => {
                    if (currentCall) {
                        // Busy line management
                        call.answer(); 
                        call.close(); 
                        return;
                    }
                    call.answer(localStream);
                    setupCallEvents(call);
                });
            });

            hostPeer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    // Room exists, connect as guest
                    connectAsClient();
                } else {
                    statusText.innerText = "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è";
                    subStatus.innerText = err.type;
                    console.error(err);
                }
            });
        }

        function connectAsClient() {
            const clientPeer = new Peer();

            clientPeer.on('open', (id) => {
                statusText.innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...";
                subStatus.innerText = "–í—Ö–æ–¥ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–æ–º–Ω–∞—Ç—É...";
                
                const call = clientPeer.call(ROOM_ID, localStream);
                setupCallEvents(call);
            });

            clientPeer.on('error', (err) => {
                statusText.innerText = "–õ–∏–Ω–∏—è –∑–∞–Ω—è—Ç–∞";
                subStatus.innerText = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Ö–æ—Å—Ç—É.";
                indicator.classList.add('busy');
            });
        }

        function setupCallEvents(call) {
            currentCall = call;

            call.on('stream', (stream) => {
                remoteAudio.srcObject = stream;
                statusText.innerText = "–í —Ä–∞–∑–≥–æ–≤–æ—Ä–µ";
                subStatus.innerText = "–ì–æ–ª–æ—Å–æ–≤–∞—è —Å–≤—è–∑—å –∞–∫—Ç–∏–≤–Ω–∞";
                indicator.classList.remove('busy');
                indicator.classList.add('online');
            });

            call.on('close', () => {
                statusText.innerText = "–û—Ç–∫–ª—é—á–µ–Ω–æ";
                subStatus.innerText = "–í—ã–∑–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω.";
                indicator.classList.remove('online');
                currentCall = null;
            });

            call.on('error', (err) => {
                statusText.innerText = "–û—à–∏–±–∫–∞ –≤—ã–∑–æ–≤–∞";
                subStatus.innerText = err.message;
                currentCall = null;
            });
        }

        init();
    </script>
</body>
</html>