<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlexVoiceChat</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #0f0f0f; color: #e0e0e0; margin: 0; }
        #status-card { background: #1e1e1e; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; border: 1px solid #333; min-width: 280px; }
        #status { font-size: 1.4rem; margin-bottom: 15px; font-weight: 300; }
        .dot { height: 12px; width: 12px; background-color: #555; border-radius: 50%; display: inline-block; margin-right: 10px; transition: 0.3s; }
        .online { background-color: #00ff88; box-shadow: 0 0 15px #00ff88; }
        .busy { background-color: #ff4444; box-shadow: 0 0 15px #ff4444; }
        .waiting-state { background-color: #ff9500; box-shadow: 0 0 15px #ff9500; } 
        .info { color: #888; font-size: 0.9rem; margin-top: 10px; }

        #controls {
            margin-top: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        
        .mic-btn {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            background: #333;
            color: white;
            font-size: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            margin: 0 auto;
        }
        
        .mic-btn:active { transform: scale(0.9); }
        .mic-btn.active {
            background: #00ff88;
            color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }
        .mic-btn.muted {
            background: #ff4444;
            color: #fff;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.3);
        }
        
        #mic-label { 
            margin-top: 12px;
            font-weight: bold; 
            letter-spacing: 0.5px; 
            display: block;
            width: 100%;
            text-align: center;
        }

        .volume-container {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #333;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .volume-container label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        input[type=range] {
            width: 90%;
            cursor: pointer;
            accent-color: #00ff88;
        }

        /* Lobby styles */
        #lobby { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .room-row { display: flex; align-items: center; justify-content: space-between; background: #252525; padding: 12px 18px; border-radius: 10px; cursor: pointer; border: 2px solid #444; transition: 0.3s; }
        
        .room-row.free-room { border-color: #00ff88; }
        .room-row.waiting-room { border-color: #ff9500; background: #2a1b00; }
        .room-row.busy-room { border-color: #ff4444; background: #2a0000; cursor: not-allowed; }

        .room-status-label { font-size: 0.75rem; text-transform: uppercase; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
        .label-free { color: #00ff88; }
        .label-waiting { color: #ff9500; }
        .label-busy { color: #ff4444; }

        #chat-interface { display: none; width: 100%; }
        .leave-btn { margin-top: 20px; background: none; border: 1px solid #ff4444; color: #ff4444; padding: 8px 15px; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        .leave-btn:hover { background: #ff4444; color: #fff; }
    </style>
</head>
<body>

    <div id="status-card">
        <div id="lobby">
            <h2 style="margin-top:0;">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É</h2>
            <div id="room-1" class="room-row free-room" onclick="joinRoom(1)">
                <span>–ö–æ–º–Ω–∞—Ç–∞ ‚Ññ1</span>
                <span id="label-1" class="room-status-label label-free">–°–í–û–ë–û–î–ù–ê</span>
            </div>
            <div id="room-2" class="room-row free-room" onclick="joinRoom(2)">
                <span>–ö–æ–º–Ω–∞—Ç–∞ ‚Ññ2</span>
                <span id="label-2" class="room-status-label label-free">–°–í–û–ë–û–î–ù–ê</span>
            </div>
            <div id="room-3" class="room-row free-room" onclick="joinRoom(3)">
                <span>–ö–æ–º–Ω–∞—Ç–∞ ‚Ññ3</span>
                <span id="label-3" class="room-status-label label-free">–°–í–û–ë–û–î–ù–ê</span>
            </div>
            <div id="room-4" class="room-row free-room" onclick="joinRoom(4)">
                <span>–ö–æ–º–Ω–∞—Ç–∞ ‚Ññ4</span>
                <span id="label-4" class="room-status-label label-free">–°–í–û–ë–û–î–ù–ê</span>
            </div>
            <div class="info">–ú–∞–∫—Å–∏–º—É–º: 8 —á–µ–ª–æ–≤–µ–∫ –Ω–∞ —Å–∞–π—Ç–µ</div>
        </div>

        <div id="chat-interface">
            <div id="status"><span class="dot" id="indicator"></span> –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
            <div id="sub-status" class="info">–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...</div>
            
            <div id="controls">
                <button id="micToggle" class="mic-btn active">üé§</button>
                <div id="mic-label" class="info">–ú–∏–∫—Ä–æ—Ñ–æ–Ω –í–ö–õ</div>
            </div>

            <div class="volume-container">
                <label for="volumeSlider">–ì—Ä–æ–º–∫–æ—Å—Ç—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞: <span id="volumeValue">100</span>%</label>
                <input type="range" id="volumeSlider" min="0" max="100" value="100">
            </div>

            <button class="leave-btn" onclick="leaveRoom()">–ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
        </div>
    </div>
    
    <audio id="remoteAudio" autoplay></audio>

    <script>
        const statusText = document.getElementById('status');
        const subStatus = document.getElementById('sub-status');
        const indicator = document.getElementById('indicator');
        const remoteAudio = document.getElementById('remoteAudio');
        const micToggle = document.getElementById('micToggle');
        const micLabel = document.getElementById('mic-label');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeValue = document.getElementById('volumeValue');
        const lobby = document.getElementById('lobby');
        const chatInterface = document.getElementById('chat-interface');

        let localStream;
        let peer = null;
        let currentCall = null;
        let isMuted = false;
        let activeRoomId = '';
        let scanInterval = null;

        const roomStates = { 1: 'free', 2: 'free', 3: 'free', 4: 'free' };

        function updateRoomUI(num, state) {
            roomStates[num] = state;
            const row = document.getElementById(`room-${num}`);
            const label = document.getElementById(`label-${num}`);
            if (!row || !label) return;

            row.className = 'room-row ' + (state === 'busy' ? 'busy-room' : (state === 'waiting' ? 'waiting-room' : 'free-room'));
            label.className = 'room-status-label ' + (state === 'busy' ? 'label-busy' : (state === 'waiting' ? 'label-waiting' : 'label-free'));
            label.innerText = state === 'busy' ? '–ó–ê–ù–Ø–¢–û' : (state === 'waiting' ? '–û–ñ–ò–î–ê–ù–ò–ï' : '–°–í–û–ë–û–î–ù–ê');
        }

        async function scanRooms() {
            if (chatInterface.style.display === 'block') return;

            for (let i = 1; i <= 4; i++) {
                const targetId = `alex-room-v1-${i}`;
                const checker = new Peer();
                
                checker.on('open', (id) => {
                    // 1. –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ ID. –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ - —Ç–∞–º –æ–¥–∏–Ω —á–µ–ª–æ–≤–µ–∫ –∂–¥–µ—Ç.
                    const conn = checker.connect(targetId, { reliable: true });
                    let answered = false;

                    conn.on('open', () => {
                        answered = true;
                        updateRoomUI(i, 'waiting');
                        checker.destroy();
                    });

                    // 2. –ï—Å–ª–∏ –∑–∞ 1.5 —Å–µ–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å - ID –ª–∏–±–æ —Å–≤–æ–±–æ–¥–µ–Ω, –ª–∏–±–æ –¢–ê–ú –î–í–û–ï.
                    setTimeout(() => {
                        if (!answered && !checker.destroyed) {
                            // –ü—Ä–æ–±—É–µ–º –Ω–∞ –¥–æ–ª—é —Å–µ–∫—É–Ω–¥—ã —Å–∞–º–∏ —Å—Ç–∞—Ç—å –•–æ—Å—Ç–æ–º —ç—Ç–æ–≥–æ ID
                            const tryHost = new Peer(targetId);
                            tryHost.on('open', () => {
                                updateRoomUI(i, 'free'); // –£–¥–∞–ª–æ—Å—å –∑–∞–Ω—è—Ç—å? –ó–Ω–∞—á–∏—Ç –±—ã–ª–æ —Å–≤–æ–±–æ–¥–Ω–æ.
                                tryHost.destroy();
                                checker.destroy();
                            });
                            tryHost.on('error', (err) => {
                                if (err.type === 'unavailable-id') {
                                    updateRoomUI(i, 'busy'); // –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–Ω—è—Ç—å ID? –ó–Ω–∞—á–∏—Ç —Ç–∞–º —É–∂–µ –¥–≤–æ–µ –æ–±—â–∞—é—Ç—Å—è.
                                }
                                tryHost.destroy();
                                checker.destroy();
                            });
                        }
                    }, 1500);
                });
                
                checker.on('error', () => checker.destroy());
            }
        }

        function startScanner() {
            if (!scanInterval) {
                scanRooms();
                scanInterval = setInterval(scanRooms, 8000);
            }
        }

        function stopScanner() {
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
        }

        startScanner();

        async function joinRoom(roomNum) {
            if (roomStates[roomNum] === 'busy') {
                alert("–≠—Ç–∞ –∫–æ–º–Ω–∞—Ç–∞ —É–∂–µ –∑–∞–Ω—è—Ç–∞ –¥–≤—É–º—è –ª—é–¥—å–º–∏!");
                return;
            }

            stopScanner();
            activeRoomId = `alex-room-v1-${roomNum}`;
            lobby.style.display = 'none';
            chatInterface.style.display = 'block';
            init();
        }

        async function init() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                subStatus.innerText = "–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≥–æ—Ç–æ–≤.";
                micToggle.addEventListener('click', toggleMic);
                volumeSlider.addEventListener('input', updateVolume);
                volumeSlider.addEventListener('wheel', handleVolumeWheel, { passive: false });
                startPeer();
            } catch (err) { 
                alert("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω"); 
                location.reload();
            }
        }

        function startPeer() {
            peer = new Peer(activeRoomId);
            peer.on('open', () => {
                statusText.innerText = "–û–∂–∏–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞...";
                indicator.className = "dot waiting-state";
                peer.on('call', (call) => {
                    if (currentCall) { call.answer(); call.close(); return; }
                    call.answer(localStream);
                    setupCallEvents(call);
                });
            });
            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') connectAsClient();
            });
        }

        function connectAsClient() {
            const clientPeer = new Peer();
            clientPeer.on('open', () => {
                const call = clientPeer.call(activeRoomId, localStream);
                setupCallEvents(call);
            });
        }

        function setupCallEvents(call) {
            currentCall = call;
            call.on('stream', (stream) => {
                remoteAudio.srcObject = stream;
                statusText.innerText = "–í —Ä–∞–∑–≥–æ–≤–æ—Ä–µ";
                indicator.className = "dot online";
            });
            call.on('close', () => leaveRoom());
        }

        function toggleMic() {
            isMuted = !isMuted;
            localStream.getAudioTracks().forEach(t => t.enabled = !isMuted);
            micToggle.className = isMuted ? 'mic-btn muted' : 'mic-btn active';
            micToggle.innerText = isMuted ? 'üîá' : 'üé§';
            micLabel.innerText = isMuted ? "–ú–∏–∫—Ä–æ—Ñ–æ–Ω –í–´–ö–õ" : "–ú–∏–∫—Ä–æ—Ñ–æ–Ω –í–ö–õ";
        }

        function updateVolume() {
            remoteAudio.volume = volumeSlider.value / 100;
            volumeValue.innerText = volumeSlider.value;
        }

        function handleVolumeWheel(e) {
            e.preventDefault();
            let val = parseInt(volumeSlider.value);
            val = e.deltaY < 0 ? Math.min(100, val + 5) : Math.max(0, val - 5);
            volumeSlider.value = val;
            updateVolume();
        }

        function leaveRoom() { location.reload(); }
    </script>
</body>
</html>